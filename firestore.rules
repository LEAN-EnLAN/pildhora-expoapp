rules_version = '2'

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isSelf(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function getUser(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function userRole() {
      return isSignedIn() ? getUser(request.auth.uid).data.role : null;
    }

    function isCaregiver() {
      return userRole() == "caregiver";
    }

    // users collection: allow users to read/write their own document.
    // Caregivers can read any user (needed to see patient info), but only write their own.
    match /users/{uid} {
      allow read: if isSignedIn();
      allow write: if isSelf(uid);
    }

    // notificationPreferences/{userId}: only that user can read/write.
    match /notificationPreferences/{userId} {
      allow read, write: if isSelf(userId);
    }

    // tasks: caregiver-owned tasks (caregiverId field).
    // Only the caregiver who owns the task can read/write it.
    match /tasks/{taskId} {
      allow read: if isSignedIn() && resource.data.caregiverId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.caregiverId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.caregiverId == request.auth.uid;
    }

    // medications: documents contain patientId and caregiverId.
    // Allow read/write for the patient or caregiver associated with the medication.
    match /medications/{medicationId} {
      allow read, write: if isSignedIn() &&
        (
          (request.auth.uid == resource.data.patientId) ||
          (request.auth.uid == resource.data.caregiverId) ||
          (request.auth.uid == request.resource.data.patientId) ||
          (request.auth.uid == request.resource.data.caregiverId)
        );
    }

    // intakeRecords: documents contain patientId.
    // Allow patient to read/write their own records.
    // Caregivers may read/update but not delete; this can be refined later to only linked caregivers.
    match /intakeRecords/{intakeId} {
      allow read, create, update: if isSignedIn() &&
        (
          request.auth.uid == resource.data.patientId ||
          request.auth.uid == request.resource.data.patientId ||
          isCaregiver()
        );
      allow delete: if isSignedIn() &&
        (
          request.auth.uid == resource.data.patientId ||
          request.auth.uid == request.resource.data.patientId
        );
    }

    // devices collection: documents include linkedUsers map and primaryPatientId.
    // Allow read/write for users listed in linkedUsers; other access is blocked.
    match /devices/{deviceId} {
      allow read, write: if isSignedIn() &&
        (request.auth.uid in (resource.data.linkedUsers.keys() || []) ||
         request.auth.uid in (request.resource.data.linkedUsers.keys() || []));
    }

    // deviceLinks: relationships between devices and users.
    // Allow users to read links where they are involved (either as patient or caregiver).
    // Users can create links for themselves, and update/delete their own links.
    match /deviceLinks/{linkId} {
      allow read: if isSignedIn() &&
        (request.auth.uid == resource.data.userId);
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.keys().hasAll(['deviceId', 'userId', 'role', 'status', 'linkedAt']) &&
        request.resource.data.role in ['patient', 'caregiver'] &&
        request.resource.data.status in ['active', 'inactive'];
      allow update, delete: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
    }

    // deviceConfigs: configuration per device. Only users linked to the device may read/write.
    match /deviceConfigs/{deviceId} {
      allow read, write: if isSignedIn() &&
        (
          // Look up the device document and ensure the user is in linkedUsers.
          (request.auth.uid in (get(/databases/$(database)/documents/devices/$(deviceId)).data.linkedUsers.keys() || []))
        );
    }

    // medicationEvents: events generated when medications are created/updated/deleted or doses are taken.
    // Both patients and caregivers can read events they're associated with.
    // Both patients and caregivers can create events for medications they manage.
    match /medicationEvents/{eventId} {
      // Helper function to check if the request is within rate limit
      // Note: This is a simplified check. For production, consider using Cloud Functions
      // to enforce rate limiting more accurately, as Firestore rules have query limitations.
      function isWithinRateLimit() {
        // Rate limiting in security rules is limited due to query constraints.
        // This function serves as a placeholder for the rate limit logic.
        // Actual enforcement should be done via Cloud Functions or client-side throttling.
        // For now, we allow the operation and rely on monitoring.
        return true;
      }

      // Helper function to validate event data structure
      function isValidEventData() {
        let data = request.resource.data;
        return data.keys().hasAll(['eventType', 'medicationId', 'medicationName', 'patientId', 'timestamp', 'syncStatus']) &&
               data.eventType in ['medication_created', 'medication_updated', 'medication_deleted', 'dose_taken', 'dose_missed'] &&
               data.medicationId is string &&
               data.medicationName is string &&
               data.patientId is string &&
               data.timestamp is timestamp &&
               data.syncStatus in ['pending', 'synced', 'failed'] &&
               // Ensure the authenticated user is either the patient or has caregiverId field matching
               (data.patientId == request.auth.uid || 
                (data.keys().hasAny(['caregiverId']) && data.caregiverId == request.auth.uid)) &&
               // Validate optional fields
               (!data.keys().hasAny(['medicationData']) || data.medicationData is map) &&
               (!data.keys().hasAny(['changes']) || data.changes is list) &&
               (!data.keys().hasAny(['caregiverId']) || data.caregiverId is string) &&
               (!data.keys().hasAny(['patientName']) || data.patientName is string);
      }

      // Read access: both the patient and the assigned caregiver can read events
      allow read: if isSignedIn() && 
        (resource.data.patientId == request.auth.uid ||
         (resource.data.keys().hasAny(['caregiverId']) && resource.data.caregiverId == request.auth.uid));

      // Create access: authenticated users can create events for medications they're associated with
      allow create: if isSignedIn() && 
        isValidEventData() &&
        isWithinRateLimit();

      // Update access: only the creator (patient or caregiver) can update events
      allow update: if isSignedIn() && 
        (resource.data.patientId == request.auth.uid ||
         (resource.data.keys().hasAny(['caregiverId']) && resource.data.caregiverId == request.auth.uid));

      // Delete access: only the creator can delete events
      allow delete: if isSignedIn() && 
        (resource.data.patientId == request.auth.uid ||
         (resource.data.keys().hasAny(['caregiverId']) && resource.data.caregiverId == request.auth.uid));
    }

    // fallback: deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
